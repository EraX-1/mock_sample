COMPOSE_PROJECT_NAME := erax-chatbot-template
API_CONTAINER := erax-chatbot-template-api

# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ã®è¨­å®š
LOCAL_COMPOSE_PROJECT_NAME := yuyama-local
LOCAL_API_CONTAINER := yuyama-api-local

DOCKER_COMPOSE_VERSION_CHECKER := $(shell docker compose > /dev/null 2>&1 ; echo $$?)
ifeq ($(DOCKER_COMPOSE_VERSION_CHECKER), 0)
	DOCKER_COMPOSE=docker compose
else
	DOCKER_COMPOSE=docker-compose
endif

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
.PHONY: init
init: up-d run

# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒç”¨ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
.PHONY: init-local
init-local: up-d-local run-local

.PHONY: build
build:
	$(DOCKER_COMPOSE) -p $(COMPOSE_PROJECT_NAME) build --no-cache

.PHONY: up-d
up-d:
	$(DOCKER_COMPOSE) -p $(COMPOSE_PROJECT_NAME) up -d

.PHONY: down
down:
	$(DOCKER_COMPOSE) -p $(COMPOSE_PROJECT_NAME) down

.PHONY: exec
exec:
	docker exec -it $(API_CONTAINER) bash

.PHONY: run
run:
	docker exec -it $(API_CONTAINER) bash -c "uvicorn src.main:app --reload --host 0.0.0.0 --port 8080"

.PHONY: reload-config
reload-config:
	docker cp config.toml $(API_CONTAINER):/app/config.toml

.PHONY: install-requirements
install-requirements:
	docker cp requirements.txt $(API_CONTAINER):/app/requirements.txt
	docker exec -it $(API_CONTAINER) bash -c "pip install -r requirements.txt"

.PHONY: install-requirements-local
install-requirements-local:
	pip3 install -r requirements.txt --break-system-packages

.PHONY: logs
logs:
	docker logs -f $(API_CONTAINER)

.PHONY: logs-tail
logs-tail:
	docker logs -f --tail 100 $(API_CONTAINER)

# =================== ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒç”¨ã‚³ãƒãƒ³ãƒ‰ ===================

.PHONY: build-local
build-local:
	$(DOCKER_COMPOSE) -f docker-compose.local.yml -p $(LOCAL_COMPOSE_PROJECT_NAME) build --no-cache

.PHONY: up-d-local
up-d-local:
	$(DOCKER_COMPOSE) -f docker-compose.local.yml -p $(LOCAL_COMPOSE_PROJECT_NAME) up -d

.PHONY: down-local
down-local:
	$(DOCKER_COMPOSE) -f docker-compose.local.yml -p $(LOCAL_COMPOSE_PROJECT_NAME) down

.PHONY: exec-local
exec-local:
	docker exec -it $(LOCAL_API_CONTAINER) bash

.PHONY: run-local
run-local:
	docker exec -it $(LOCAL_API_CONTAINER) bash -c "uvicorn src.main:app --reload --host 0.0.0.0 --port 8080"

.PHONY: logs-local
logs-local:
	docker logs -f $(LOCAL_API_CONTAINER)

.PHONY: logs-tail-local
logs-tail-local:
	docker logs -f --tail 100 $(LOCAL_API_CONTAINER)

# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼šãƒ›ã‚¹ãƒˆã§ç›´æ¥å®Ÿè¡Œ
.PHONY: dev
dev:
	cp config.local.toml config.toml
	uvicorn src.main:app --reload --host 0.0.0.0 --port 8080

# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã¿èµ·å‹•
.PHONY: db-only-local
db-only-local:
	$(DOCKER_COMPOSE) -f docker-compose.local.yml -p $(LOCAL_COMPOSE_PROJECT_NAME) up -d db

# è¨­å®šã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®åˆæœŸåŒ–
.PHONY: setup-local
setup-local:
	@echo "ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™..."
	cp config.local.toml config.toml
	mkdir -p local_storage/blobs/mock-container
	mkdir -p local_storage/search
	@echo "âœ… ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
	@echo ""
	@echo "ğŸš€ æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã§ãã¾ã™ï¼š"
	@echo "   make dev           # ãƒ›ã‚¹ãƒˆã§ç›´æ¥å®Ÿè¡Œ"
	@echo "   make init-local    # Dockerã§å®Ÿè¡Œ"
